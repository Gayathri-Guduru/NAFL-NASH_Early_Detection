```{r}
# Install required packages if not already installed
if (!requireNamespace("BiocManager", quietly = TRUE)) {
    install.packages("BiocManager")
}
# Uncomment to install the necessary packages if not already installed
# BiocManager::install(c("GEOquery", "limma", "clusterProfiler", "org.Hs.eg.db", "KEGGREST", "msigdbr"))

# Load necessary libraries
library(GEOquery)
library(limma)
library(clusterProfiler)
library(org.Hs.eg.db)
library(KEGGREST)
library(msigdbr)
library(ggplot2)
library(pheatmap)

### Step 1: Download and Preprocess GEO Dataset (GSE182060)
# Download GSE182060 dataset from GEO
gse182060 <- getGEO("GSE182060", GSEMatrix = TRUE)[[1]]

# Function to preprocess data (log2 transformation and normalization)
preprocess_data <- function(gse) {
  exprs_data <- exprs(gse)
  
  # Log2 transformation if necessary
  if (max(exprs_data) > 100) {
    exprs_data <- log2(exprs_data + 1)
  }
  
  # Normalize between arrays using limma
  exprs_data <- normalizeBetweenArrays(exprs_data)
  return(exprs_data)
}

# Preprocess the expression data
exprs_182060 <- preprocess_data(gse182060)
```

### Explanation:
# Log2 transformation is applied to normalize the dataset, making the values comparable and reducing large variations in gene expression. 
# Normalization is performed to ensure that comparisons across different samples (Baseline vs Follow-up) are accurate.

```{r}
### Step 2: Differential Expression Analysis (Baseline vs. Follow-up)
# Extract phenotype data
pheno_182060 <- pData(gse182060)

# Subset data to include only Baseline and Follow-up samples
valid_samples <- pheno_182060$`time_point:ch1` %in% c("Baseline", "Follow-up")
exprs_subset <- exprs_182060[, valid_samples]
pheno_subset <- pheno_182060[valid_samples, ]

# Create design matrix (pairing by patient)
design <- model.matrix(~ pheno_subset$`time_point:ch1` + pheno_subset$`patient:ch1`)
colnames(design)[2] <- "Follow_up"

# Perform linear modeling and empirical Bayes statistics using limma
fit <- lmFit(exprs_subset, design)
fit <- eBayes(fit)

# Extract top differentially expressed genes (adjusted p-value and logFC thresholds)
results_182060 <- topTable(fit, coef = "Follow_up", adjust.method = "fdr", number = Inf)
significant_genes <- results_182060[results_182060$adj.P.Val < 0.1 & abs(results_182060$logFC) > 0.05, ]
nrow(significant_genes)  # Number of significant genes
```


### Explanation:
# Differential Expression Analysis is performed to identify genes that show significant expression changes between Baseline and Follow-up samples. 
# The "logFC" tells how much a gene's expression changes between conditions, and "adj.P.Val" indicates the statistical significance of these changes (after adjusting for multiple tests).
# Genes with large logFC values and low adjusted p-values are considered biologically significant.



```{r}
### Step 3: KEGG Pathway Enrichment Analysis
# Convert gene symbols to Entrez IDs for KEGG enrichment
symbol_to_entrez <- bitr(rownames(significant_genes), fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
entrez_ids <- symbol_to_entrez$ENTREZID

# Perform KEGG pathway enrichment using Entrez IDs
kegg_results_local <- enrichKEGG(gene = entrez_ids, organism = "hsa", keyType = "ncbi-geneid")
head(kegg_results_local)  # View top KEGG results

# Save KEGG pathway enrichment results to a CSV file
write.csv(as.data.frame(kegg_results_local), file = "GSE182060_KEGG_Pathway_Results.csv")
```

### Explanation:
# Pathway enrichment analysis helps to identify biological pathways (e.g., metabolic, immune signaling) that are overrepresented among the differentially expressed genes.
# KEGG pathways represent specific biochemical and signal transduction pathways, providing insights into the underlying biological mechanisms impacted by the changes in gene expression.



```{r}
### Step 4: Gene Set Enrichment Analysis (GSEA) for GO Biological Processes
gsea_significant_genes <- rownames(significant_genes)

# Perform GSEA using GO Biological Processes (BP)
gsea_results <- enrichGO(gene = gsea_significant_genes, OrgDb = org.Hs.eg.db, keyType = "SYMBOL", ont = "BP")
head(gsea_results)  # View top GSEA results

# Save GSEA results for GO Biological Processes
write.csv(as.data.frame(gsea_results), file = "GSE182060_GSEA_GO_BP.csv")
```

### Explanation:
# Gene Ontology (GO) enrichment analysis focuses on biological processes that are significantly associated with the set of differentially expressed genes.
# This can reveal insights into biological functions such as cell cycle, immune response, or metabolic processes affected by the changes in gene expression.


```{r}
### Step 5: GSEA for Predefined KEGG Gene Sets (using msigdbr)
# Load KEGG gene sets using msigdbr
kegg_gene_sets <- msigdbr(species = "Homo sapiens", category = "C2", subcategory = "CP:KEGG")

# Perform GSEA using KEGG gene sets from msigdbr
kegg_enrichment_msigdbr <- enricher(gene = gsea_significant_genes, TERM2GENE = kegg_gene_sets[, c("gs_name", "gene_symbol")])
head(kegg_enrichment_msigdbr)  # View KEGG GSEA results

# Save KEGG GSEA results
write.csv(as.data.frame(kegg_enrichment_msigdbr), file = "GSE182060_KEGG_GSEA_msigdbr.csv")
```

### Explanation:
# KEGG gene sets from msigdbr provide an alternative way of exploring KEGG pathways, specifically using predefined gene sets associated with these pathways.
# Performing GSEA on these predefined sets helps identify whether specific pathways are enriched among your significant genes.

```{r}
### Step 6: Visualization
# Create a volcano plot for the differentially expressed genes
volcano_data <- data.frame(logFC = results_182060$logFC, adj.P.Val = results_182060$adj.P.Val)
volcano_plot <- ggplot(volcano_data, aes(x = logFC, y = -log10(adj.P.Val))) +
  geom_point(alpha = 0.4) +
  theme_minimal() +
  xlab("Log Fold Change") +
  ylab("-log10 Adjusted P-value") +
  ggtitle("Volcano Plot - GSE182060 (Baseline vs. Follow-up)")

# Save the volcano plot as a JPEG
ggsave(volcano_plot, filename = "volcano_plot_GSE182060.jpeg", width = 8, height = 6)

# Create a heatmap for the top 20 differentially expressed genes
top_genes <- rownames(head(results_182060, 20))
exprs_top_genes <- exprs_182060[top_genes, ]
heatmap_plot <- pheatmap(exprs_top_genes, scale = "row", show_rownames = TRUE, cluster_cols = TRUE)

# Save the heatmap as a JPEG
ggsave(heatmap_plot, filename = "heatmap_GSE182060.jpeg", device = "jpeg", height = 6, width = 22, units = "in")
```

### Explanation:
- **Volcano Plot**: This plot provides an overview of which genes are most significantly differentially expressed (y-axis shows significance, x-axis shows magnitude of change). Genes with high logFC and low p-values are of particular interest.
- **Heatmap**: The heatmap visualizes the expression patterns of the top 20 differentially expressed genes across samples. This can reveal clustering patterns, indicating gene expression trends between Baseline and Follow-up samples.

### Final Interpretation:
- **Upregulated Genes (Positive logFC)**: These genes are more highly expressed in Follow-up, potentially pointing to pathways or biological processes that are activated over time or with treatment.
- **Downregulated Genes (Negative logFC)**: These genes are less expressed in Follow-up, suggesting they may be involved in processes that are suppressed during disease progression or treatment.
- **GSEA/KEGG Pathways**: The enriched pathways provide insights into how the changes in gene expression affect biological functions, potentially identifying key mechanisms related to liver disease, recovery, or treatment response.
